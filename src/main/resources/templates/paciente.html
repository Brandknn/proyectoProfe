<!DOCTYPE html>
<html lang="es">
  <head>
    <link rel="stylesheet" href="/estilosAdministrativos.css" />
    <link rel="stylesheet" href="/gestionCitas.css" />
    <link rel="stylesheet" href="/mensajes-comunes.css" />
    <link rel="stylesheet" href="/paciente.css" />
    <meta charset="UTF-8" />
    <title>Gesti√≥n de Pacientes</title>
  </head>
  <body class="dark-mode">
    <nav>
       <input type="checkbox" id="theme-toggle" style="display: none;">
    
    <!-- Label que act√∫a como bot√≥n -->
    <label for="theme-toggle" style="cursor: pointer; position: fixed; bottom: 20px; right: 20px; background: #005b9f; color: white; padding: 10px; border-radius: 5px;">üåô</label>
      <p class="logo">M√©dico Independiente</p>
      <div class="nav_bar">
        <a href="/paciente" class="active">Pacientes</a>
        <a href="/gestionCitas">Gesti√≥n de Citas</a>
        <a href="/historialCitas">Historial</a>
        <a href="/calendarioMedico">Calendario</a>
        <a href="/dictamen">Dict√°menes</a>
        <a href="/horario">Horarios</a>
        <a href="/PerfilMedicoAjustes">Perfil M√©dico</a>
      </div>
    </nav>

    <h1>Gesti√≥n de Pacientes</h1>

    <div th:if="${error}" class="toast error" th:text="${error}"></div>
    <div th:if="${success}" class="toast success" th:text="${success}"></div>

    <h2>Registrar Paciente</h2>
    <form
      action="/agregarPaciente"
      th:object="${paciente}"
      method="post"
      class="formulario-paciente"
      id="formPaciente"
    >
      <label>Nombre:</label>
      <input
        type="text"
        th:field="*{nombre}"
        id="nombre"
        name="nombre"
        pattern="[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]+"
        required
      /><br />
      <div class="field-error-message" id="errorNombre"></div>
      <br />

      <label>Apellido:</label>
      <input
        type="text"
        th:field="*{apellido}"
        id="apellido"
        name="apellido"
        pattern="[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]+"
        required
      /><br />
      <div class="field-error-message" id="errorApellido"></div>
      <br />

      <label>Documento:</label>
      <input
        type="text"
        th:field="*{documento}"
        id="documento"
        name="documento"
        pattern="[0-9]+"
        maxlength="10"
        required
      /><br />
      <div class="field-error-message" id="errorDocumento"></div>
      <br />

      <label>Tel√©fono:</label>
      <input
        type="text"
        th:field="*{telefono}"
        id="telefono"
        name="telefono"
        pattern="3[0-9]{9}"
        maxlength="10"
        required
      /><br />
      <div class="field-error-message" id="errorTelefono"></div>
      <br />

      <label>Correo:</label>
      <input
        type="email"
        th:field="*{correo}"
        id="correo"
        name="correo"
      /><br />
      <div class="field-error-message" id="errorCorreo"></div>
      <br />

      <button type="submit">Guardar Paciente</button>
    </form>

    <h2>Listado de Pacientes</h2>
    <table border="1">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Apellido</th>
          <th>Documento</th>
          <th>Tel√©fono</th>
          <th>Correo</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr th:each="pac : ${pacientes}">
          <td th:text="${pac.nombre}"></td>
          <td th:text="${pac.apellido}"></td>
          <td th:text="${pac.documento}"></td>
          <td th:text="${pac.telefono}"></td>
          <td th:text="${pac.correo}"></td>
          <td>
            <button
              class="btn-editar"
              th:attr="data-id=${pac.id}, data-nombre=${pac.nombre}, data-apellido=${pac.apellido}, data-documento=${pac.documento}, data-telefono=${pac.telefono}, data-correo=${pac.correo}"
              onclick="editarPacienteData(this)"
            >
              Editar
            </button>

            <button
              class="btn-eliminar"
              th:onclick="'confirmarEliminar(' + ${pac.id} + ')'"
            >
              Eliminar
            </button>

            <form
              th:action="@{/eliminarPaciente}"
              method="post"
              th:id="'formEliminar-' + ${pac.id}"
              style="display: none"
            >
              <input type="hidden" name="id" th:value="${pac.id}" />
            </form>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Modal Editar -->
    <div id="modalEditar" class="modal">
      <div class="modal-content">
        <span class="close" onclick="cerrarModal('modalEditar')">&times;</span>
        <h2>Editar Paciente</h2>
        <form action="/actualizarPaciente" method="post">
          <input type="hidden" id="editId" name="id" />

          <label>NOMBRE:</label>
          <input
            type="text"
            id="editNombre"
            name="nombre"
            required
          /><br /><br />

          <label>APELLIDO:</label>
          <input
            type="text"
            id="editApellido"
            name="apellido"
            required
          /><br /><br />

          <label>DOCUMENTO:</label>
          <input
            type="text"
            id="editDocumento"
            name="documento"
            maxlength="10"
            required
          /><br /><br />

          <label>TEL√âFONO:</label>
          <input
            type="text"
            id="editTelefono"
            name="telefono"
            pattern="3[0-9]{9}"
            maxlength="10"
            required
          /><br /><br />

          <label>CORREO:</label>
          <input
            type="email"
            id="editCorreo"
            name="correo"
            required
          /><br /><br />

          <div class="modal-buttons">
            <button
              type="button"
              class="btn-cancelar"
              onclick="cerrarModal('modalEditar')"
            >
              Cancelar
            </button>
            <button type="submit" class="btn-confirmar">Actualizar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Confirmar Eliminaci√≥n -->
    <div id="modalEliminar" class="modal">
      <div class="modal-content">
        <span class="close" onclick="cerrarModal('modalEliminar')"
          >&times;</span
        >
        <h2>Confirmar Eliminaci√≥n</h2>
        <p>
          ¬øEst√° seguro de que desea eliminar este paciente? Esta acci√≥n no se
          puede deshacer.
        </p>
        <div class="modal-buttons">
          <button
            type="button"
            class="btn-cancelar"
            onclick="cerrarModal('modalEliminar')"
          >
            Cancelar
          </button>
          <button
            type="button"
            class="btn-confirmar"
            id="btnConfirmarEliminar"
            style="background-color: #dc3545"
          >
            Eliminar
          </button>
        </div>
      </div>
    </div>

    <script>
      // Validaci√≥n en tiempo real para el formulario de registro
      const form = document.getElementById("formPaciente");
      const inputNombre = document.getElementById("nombre");
      const inputApellido = document.getElementById("apellido");
      const inputDocumento = document.getElementById("documento");
      const inputTelefono = document.getElementById("telefono");
      const inputCorreo = document.getElementById("correo");

      // Variables para rastrear si el usuario ha tocado cada campo
      let nombreTocado = false;
      let apellidoTocado = false;
      let documentoTocado = false;
      let telefonoTocado = false;
      let correoTocado = false;

      function validarNombre() {
        if (!nombreTocado) return; // No validar si no ha sido tocado

        const valor = inputNombre.value.trim();
        const regex = /^[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]+$/;
        const esValido = valor === "" || regex.test(valor);
        const errorDiv = document.getElementById("errorNombre");

        if (valor && !esValido) {
          inputNombre.classList.add("input-error");
          inputNombre.classList.remove("input-valid");
          errorDiv.textContent = "El nombre solo puede contener letras";
          errorDiv.classList.add("show");
        } else {
          inputNombre.classList.remove("input-error");
          if (valor && esValido) {
            inputNombre.classList.add("input-valid");
          } else {
            inputNombre.classList.remove("input-valid");
          }
          errorDiv.textContent = "";
          errorDiv.classList.remove("show");
        }
      }

      function validarApellido() {
        if (!apellidoTocado) return; // No validar si no ha sido tocado

        const valor = inputApellido.value.trim();
        const regex = /^[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]+$/;
        const esValido = valor === "" || regex.test(valor);
        const errorDiv = document.getElementById("errorApellido");

        if (valor && !esValido) {
          inputApellido.classList.add("input-error");
          inputApellido.classList.remove("input-valid");
          errorDiv.textContent = "El apellido solo puede contener letras";
          errorDiv.classList.add("show");
        } else {
          inputApellido.classList.remove("input-error");
          if (valor && esValido) {
            inputApellido.classList.add("input-valid");
          } else {
            inputApellido.classList.remove("input-valid");
          }
          errorDiv.textContent = "";
          errorDiv.classList.remove("show");
        }
      }

      function validarDocumento() {
        if (!documentoTocado) return; // No validar si no ha sido tocado

        const valor = inputDocumento.value.trim();
        const regex = /^[0-9]+$/;
        const esValido = valor === "" || regex.test(valor);
        const errorDiv = document.getElementById("errorDocumento");

        if (valor && !esValido) {
          inputDocumento.classList.add("input-error");
          inputDocumento.classList.remove("input-valid");
          errorDiv.textContent = "El documento solo puede contener n√∫meros";
          errorDiv.classList.add("show");
        } else if (valor && valor.length < 6) {
          inputDocumento.classList.add("input-error");
          inputDocumento.classList.remove("input-valid");
          errorDiv.textContent = "El documento debe tener al menos 6 d√≠gitos";
          errorDiv.classList.add("show");
        } else if (valor && esValido) {
          // Verificar si el documento ya existe
          fetch(`/api/verificar-documento?documento=${valor}`)
            .then((response) => response.text())
            .then((result) => {
              if (result === "duplicado") {
                inputDocumento.classList.add("input-error");
                inputDocumento.classList.remove("input-valid");
                errorDiv.textContent = "Este documento ya est√° registrado";
                errorDiv.classList.add("show");
              } else {
                inputDocumento.classList.remove("input-error");
                inputDocumento.classList.add("input-valid");
                errorDiv.textContent = "";
                errorDiv.classList.remove("show");
              }
            })
            .catch(() => {
              inputDocumento.classList.add("input-valid");
              errorDiv.classList.remove("show");
            });
        } else {
          inputDocumento.classList.remove("input-error");
          inputDocumento.classList.remove("input-valid");
          errorDiv.textContent = "";
          errorDiv.classList.remove("show");
        }
      }

      function validarTelefono() {
        if (!telefonoTocado) return; // No validar si no ha sido tocado

        const valor = inputTelefono.value.trim();
        const regex = /^3[0-9]{9}$/; // Debe empezar con 3 y tener exactamente 10 d√≠gitos
        const esValido = valor === "" || regex.test(valor);
        const errorDiv = document.getElementById("errorTelefono");

        if (valor && !esValido) {
          inputTelefono.classList.add("input-error");
          inputTelefono.classList.remove("input-valid");
          errorDiv.textContent = "N√∫mero incorrecto";
          errorDiv.classList.add("show");
        } else if (valor && esValido) {
          // Verificar si el tel√©fono ya existe
          fetch(`/api/verificar-telefono?telefono=${valor}`)
            .then((response) => response.text())
            .then((result) => {
              if (result === "duplicado") {
                inputTelefono.classList.add("input-error");
                inputTelefono.classList.remove("input-valid");
                errorDiv.textContent = "Este tel√©fono ya est√° registrado";
                errorDiv.classList.add("show");
              } else {
                inputTelefono.classList.remove("input-error");
                inputTelefono.classList.add("input-valid");
                errorDiv.textContent = "";
                errorDiv.classList.remove("show");
              }
            })
            .catch(() => {
              inputTelefono.classList.add("input-valid");
              errorDiv.classList.remove("show");
            });
        } else {
          inputTelefono.classList.remove("input-error");
          inputTelefono.classList.remove("input-valid");
          errorDiv.textContent = "";
          errorDiv.classList.remove("show");
        }
      }

      function validarCorreo() {
        if (!correoTocado) return; // No validar si no ha sido tocado

        const valor = inputCorreo.value.trim();
        const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const esValido = valor === "" || regex.test(valor);
        const errorDiv = document.getElementById("errorCorreo");

        if (valor && !esValido) {
          inputCorreo.classList.add("input-error");
          inputCorreo.classList.remove("input-valid");
          errorDiv.textContent = "Formato de correo inv√°lido";
          errorDiv.classList.add("show");
        } else if (valor && esValido) {
          // Verificar si el correo ya existe
          fetch(`/api/verificar-correo?correo=${encodeURIComponent(valor)}`)
            .then((response) => response.text())
            .then((result) => {
              if (result === "duplicado") {
                inputCorreo.classList.add("input-error");
                inputCorreo.classList.remove("input-valid");
                errorDiv.textContent = "Este correo ya est√° registrado";
                errorDiv.classList.add("show");
              } else {
                inputCorreo.classList.remove("input-error");
                inputCorreo.classList.add("input-valid");
                errorDiv.textContent = "";
                errorDiv.classList.remove("show");
              }
            })
            .catch(() => {
              inputCorreo.classList.add("input-valid");
              errorDiv.classList.remove("show");
            });
        } else {
          inputCorreo.classList.remove("input-error");
          inputCorreo.classList.remove("input-valid");
          errorDiv.textContent = "";
          errorDiv.classList.remove("show");
        }
      }

      // Event listeners para marcar como tocado y validar en tiempo real
      inputNombre.addEventListener("focus", () => {
        nombreTocado = true;
        validarNombre();
      });
      inputNombre.addEventListener("input", validarNombre);

      inputApellido.addEventListener("focus", () => {
        apellidoTocado = true;
        validarApellido();
      });
      inputApellido.addEventListener("input", validarApellido);

      inputDocumento.addEventListener("focus", () => {
        documentoTocado = true;
        validarDocumento();
      });
      inputDocumento.addEventListener("input", validarDocumento);

      inputTelefono.addEventListener("focus", () => {
        telefonoTocado = true;
        validarTelefono();
      });
      inputTelefono.addEventListener("input", validarTelefono);

      inputCorreo.addEventListener("focus", () => {
        correoTocado = true;
        validarCorreo();
      });
      inputCorreo.addEventListener("input", validarCorreo);

      // Validar antes de enviar el formulario
      form.addEventListener("submit", function (e) {
        nombreTocado = true;
        apellidoTocado = true;
        documentoTocado = true;
        telefonoTocado = true;
        correoTocado = true;

        validarNombre();
        validarApellido();
        validarDocumento();
        validarTelefono();
        validarCorreo();

        const hayErrores =
          inputNombre.classList.contains("input-error") ||
          inputApellido.classList.contains("input-error") ||
          inputDocumento.classList.contains("input-error") ||
          inputTelefono.classList.contains("input-error") ||
          inputCorreo.classList.contains("input-error");

        if (hayErrores) {
          e.preventDefault();
        }
      });

      function editarPacienteData(button) {
        document.getElementById("editId").value =
          button.getAttribute("data-id");
        document.getElementById("editNombre").value =
          button.getAttribute("data-nombre");
        document.getElementById("editApellido").value =
          button.getAttribute("data-apellido");
        document.getElementById("editDocumento").value =
          button.getAttribute("data-documento");
        document.getElementById("editTelefono").value =
          button.getAttribute("data-telefono");
        document.getElementById("editCorreo").value =
          button.getAttribute("data-correo");
        document.getElementById("modalEditar").style.display = "flex";
      }

      // Funciones para Modal Eliminar
      let idPacienteAEliminar = null;
      function confirmarEliminar(id) {
        idPacienteAEliminar = id;
        document.getElementById("modalEliminar").style.display = "flex";

        document.getElementById("btnConfirmarEliminar").onclick = function () {
          document
            .getElementById("formEliminar-" + idPacienteAEliminar)
            .submit();
        };
      }

      function cerrarModal(modalId) {
        document.getElementById(modalId).style.display = "none";
      }

      window.onclick = function (event) {
        if (event.target.classList.contains("modal")) {
          event.target.style.display = "none";
        }
      };

      // Auto-ocultar toasts despu√©s de 5 segundos
      const toasts = document.querySelectorAll(".toast");
      toasts.forEach((toast) => {
        setTimeout(function () {
          toast.classList.add("hide");
          setTimeout(function () {
            toast.remove();
          }, 300);
        }, 5000);
      });
    </script>
    <script src="dark-mode.js"></script>
  </body>
</html>
