<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Calendario M√©dico</title>
    <link rel="icon" type="image/png" href="/icono.png" />
    <link rel="stylesheet" href="/estilosAdministrativos.css" />
    <link rel="stylesheet" href="/calendarioMedico.css" />
    <link rel="stylesheet" href="/dropdown-menu.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  </head>
  <body class="dark-mode">
    <input type="checkbox" id="theme-toggle" style="display: none" />

    <!-- Label que act√∫a como bot√≥n -->
    <label
      for="theme-toggle"
      style="
        cursor: pointer;
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #005b9f;
        color: white;
        padding: 10px;
        border-radius: 5px;
        z-index: 999;
      "
      >üåô</label
    >
    <nav>
      <p class="logo">
        Dr. <span th:text="${medico != null ? medico.nombre + ' ' + medico.apellido : 'M√©dico Independiente'}">M√©dico Independiente</span>
      </p>
      <div class="nav_bar">
        <a href="/paciente">Pacientes</a>
        <a href="/gestionCitas">Gesti√≥n de Citas</a>
        <a href="/historialCitas">Historial</a>
        <a href="/calendarioMedico" class="active">Calendario</a>
        <a href="/dictamen">Dict√°menes</a>
        <a href="/horario">Horarios</a>
        <div class="dropdown">
          <a href="#" class="dropdown-toggle">
            <i class="fas fa-cog"></i> Ajustes <i class="fas fa-chevron-down"></i>
          </a>
          <div class="dropdown-menu">
            <a href="/PerfilMedicoAjustes" class="dropdown-item">
              <i class="fas fa-user-md"></i> Perfil M√©dico
            </a>
            <form action="/logout" method="post" style="margin: 0;">
              <button type="submit" class="dropdown-item logout-item">
                <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
              </button>
            </form>
          </div>
        </div>
      </div>
    </nav>

    <h1>Calendario M√©dico</h1>

    <div class="calendar-container">
      <div class="calendar-header">
        <div class="calendar-nav">
          <button onclick="cambiarMes(-1)">&#8592; Anterior</button>
        </div>
        <h2 id="mesAnio" style="color: #005b9f"></h2>
        <div class="calendar-nav">
          <button onclick="cambiarMes(1)">Siguiente &#8594;</button>
        </div>
      </div>

      <div class="calendar-grid" id="calendarGrid">
        <!-- D√≠as de la semana -->
        <div class="day-name">Dom</div>
        <div class="day-name">Lun</div>
        <div class="day-name">Mar</div>
        <div class="day-name">Mi√©</div>
        <div class="day-name">Jue</div>
        <div class="day-name">Vie</div>
        <div class="day-name">S√°b</div>
        <!-- Las celdas se generar√°n con JS -->
      </div>
    </div>

    <!-- Modal de Detalles de Cita -->
    <div id="modalDetalle" class="modal">
      <div class="modal-content" style="max-width: 400px">
        <span
          class="close"
          onclick="document.getElementById('modalDetalle').style.display='none'"
          >&times;</span
        >
        <h3 id="detalleTitulo">Detalle de Cita</h3>
        <p><strong>Paciente:</strong> <span id="detallePaciente"></span></p>
        <p><strong>Hora:</strong> <span id="detalleHora"></span></p>
        <p><strong>Motivo:</strong> <span id="detalleMotivo"></span></p>
        <p><strong>Estado:</strong> <span id="detalleEstado"></span></p>
        <div class="modal-buttons">
          <button
            type="button"
            class="btn-confirmar"
            onclick="document.getElementById('modalDetalle').style.display='none'"
          >
            Cerrar
          </button>
        </div>
      </div>
    </div>

    <script th:inline="javascript">
      /*<![CDATA[*/
      const eventos = /*[[${eventos}]]*/ [];
      /*]]>*/

      let fechaActual = new Date();

      document.addEventListener("DOMContentLoaded", () => {
        renderCalendar(fechaActual);
      });

      function cambiarMes(delta) {
        fechaActual.setMonth(fechaActual.getMonth() + delta);
        renderCalendar(fechaActual);
      }

      function renderCalendar(date) {
        const year = date.getFullYear();
        const month = date.getMonth();

        // Actualizar header
        const opciones = { month: "long", year: "numeric" };
        document.getElementById("mesAnio").textContent =
          date.toLocaleDateString("es-ES", opciones);

        const grid = document.getElementById("calendarGrid");
        // Limpiar grid manteniendo los headers
        while (grid.children.length > 7) {
          grid.removeChild(grid.lastChild);
        }

        const primerDiaMes = new Date(year, month, 1);
        const ultimoDiaMes = new Date(year, month + 1, 0);
        const diasEnMes = ultimoDiaMes.getDate();
        const diaInicioSemana = primerDiaMes.getDay(); // 0 = Domingo

        // D√≠as del mes anterior
        const ultimoDiaMesAnterior = new Date(year, month, 0).getDate();
        for (let i = diaInicioSemana - 1; i >= 0; i--) {
          const cell = createDayCell(ultimoDiaMesAnterior - i, true);
          grid.appendChild(cell);
        }

        // D√≠as del mes actual
        const hoy = new Date();
        for (let i = 1; i <= diasEnMes; i++) {
          const esHoy =
            i === hoy.getDate() &&
            month === hoy.getMonth() &&
            year === hoy.getFullYear();
          const cell = createDayCell(i, false, esHoy, year, month);
          grid.appendChild(cell);
        }

        // D√≠as del mes siguiente (para completar la cuadr√≠cula si es necesario)
        const totalCells = diaInicioSemana + diasEnMes;
        const nextMonthDays = 42 - totalCells; // 6 filas * 7 cols = 42
        if (nextMonthDays < 7) {
          // Solo llenar si queda espacio en la √∫ltima fila visual
          for (let i = 1; i <= nextMonthDays; i++) {
            const cell = createDayCell(i, true);
            grid.appendChild(cell);
          }
        }
      }

      function createDayCell(
        dayNumber,
        isOtherMonth,
        isToday = false,
        year = 0,
        month = 0
      ) {
        const cell = document.createElement("div");
        cell.className = `day-cell ${isOtherMonth ? "other-month" : ""} ${
          isToday ? "today" : ""
        }`;

        const numberDiv = document.createElement("div");
        numberDiv.className = "day-number";
        numberDiv.textContent = dayNumber;
        cell.appendChild(numberDiv);

        if (!isOtherMonth) {
          // Buscar eventos para este d√≠a
          const fechaStr = `${year}-${String(month + 1).padStart(
            2,
            "0"
          )}-${String(dayNumber).padStart(2, "0")}`;
          const eventosDia = eventos.filter((e) => e.fecha === fechaStr);

          eventosDia.sort((a, b) => a.hora.localeCompare(b.hora));

          eventosDia.forEach((evento) => {
            const pill = document.createElement("div");
            pill.className = `event-pill event-${evento.estado.toLowerCase()}`;
            pill.textContent = `${convertirHora(evento.hora)} - ${
              evento.paciente.split(" ")[0]
            }`;
            pill.onclick = (e) => {
              e.stopPropagation();
              mostrarDetalle(evento);
            };
            cell.appendChild(pill);
          });
        }

        return cell;
      }

      function convertirHora(hora24) {
        const [horas, minutos] = hora24.split(":");
        let hora = parseInt(horas);
        const ampm = hora >= 12 ? "PM" : "AM";
        hora = hora % 12 || 12;
        return `${hora}:${minutos}${ampm}`;
      }

      function mostrarDetalle(evento) {
        document.getElementById("detallePaciente").textContent =
          evento.paciente;
        document.getElementById("detalleHora").textContent = convertirHora(
          evento.hora
        );
        document.getElementById("detalleMotivo").textContent = evento.motivo;
        document.getElementById("detalleEstado").textContent = evento.estado;
        document.getElementById("modalDetalle").style.display = "flex";
      }
    </script>
    <script src="dark-mode.js"></script>
    <script src="dropdown-menu.js"></script>
  </body>
</html>
