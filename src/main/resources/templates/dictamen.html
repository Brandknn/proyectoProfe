<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Dictamen MÃ©dico</title>
    <link rel="icon" type="image/png" href="/icono.png" />
    <link rel="stylesheet" href="/estilosAdministrativos.css" />
    <link rel="stylesheet" href="/responsive.css" />
    <link rel="stylesheet" href="/dictamen.css" />
    <link rel="stylesheet" href="/dropdown-menu.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  </head>
  <body class="dark-mode">
    <input type="checkbox" id="theme-toggle" style="display: none" />

    <!-- Label que actÃºa como botÃ³n -->
    <label
      for="theme-toggle"
      style="
        cursor: pointer;
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #005b9f;
        color: white;
        padding: 10px;
        border-radius: 5px;
      "
      >ğŸŒ™</label
    >
    <nav>
      <p class="logo">MÃ©dico Independiente</p>
      <div class="nav_bar">
        <a href="/paciente">Pacientes</a>
        <a href="/gestionCitas">GestiÃ³n de Citas</a>
        <a href="/historialCitas">Historial</a>
        <a href="/calendarioMedico">Calendario</a>
        <a href="/dictamen" class="active">DictÃ¡menes</a>
        <a href="/horario">Horarios</a>
        <div class="dropdown">
          <a href="#" class="dropdown-toggle">
            <i class="fas fa-cog"></i> Ajustes <i class="fas fa-chevron-down"></i>
          </a>
          <div class="dropdown-menu">
            <a href="/PerfilMedicoAjustes" class="dropdown-item">
              <i class="fas fa-user-md"></i> Perfil MÃ©dico
            </a>
            <form action="/logout" method="post" style="margin: 0;">
              <button type="submit" class="dropdown-item logout-item">
                <i class="fas fa-sign-out-alt"></i> Cerrar SesiÃ³n
              </button>
            </form>
          </div>
        </div>
      </div>
    </nav>

    <div class="container-dictamen">
      <h1>ğŸ“‹ Dictamen MÃ©dico</h1>

      <!-- MENSAJE DE ERROR -->
      <div th:if="${error}" class="mensaje-error">
        <strong>âš ï¸ Error:</strong>
        <p th:text="${error}"></p>
      </div>

      <!-- MENSAJE DE Ã‰XITO -->
      <div th:if="${mensaje}" class="mensaje-exito">
        <strong>âœ“ Ã‰xito:</strong>
        <p th:text="${mensaje}"></p>
      </div>

      <!-- Verificar que cita no sea null -->
      <div th:if="${cita != null}">
        <!-- HEADER CON NOMBRE DEL PACIENTE -->
        <div class="paciente-header" th:if="${paciente != null}">
          <h2>ğŸ‘¤ <span th:text="${paciente.nombre}"></span></h2>
        </div>

        <!-- InformaciÃ³n de la cita -->
        <div class="info-cita">
          <h3>ğŸ“… InformaciÃ³n de la Cita</h3>
          <p><strong>ID Cita:</strong> <span th:text="${cita.id}"></span></p>
          <p><strong>Motivo:</strong> <span th:text="${cita.motivo}"></span></p>
          <p><strong>Fecha:</strong> <span th:text="${cita.fecha}"></span></p>
          <p><strong>Hora:</strong> <span th:text="${cita.hora}"></span></p>
          <p>
            <strong>Estado:</strong>
            <span class="badge-estado" th:text="${cita.estado}"></span>
          </p>
        </div>

        <!-- FORMULARIO PARA GUARDAR -->
        <div class="form-dictamen">
          <h2>
            <span
              th:if="${dictamen == null or dictamen.contenido == null or dictamen.contenido == ''}"
            >
              â• Registrar Nuevo Dictamen
            </span>
            <span
              th:unless="${dictamen == null or dictamen.contenido == null or dictamen.contenido == ''}"
            >
              âœï¸ Editar Dictamen
            </span>
          </h2>

          <form
            th:action="@{'/cita/' + ${cita.id} + '/dictamen'}"
            method="post"
            onsubmit="return validarFormulario()"
          >
            <label for="contenido">Resultado / DiagnÃ³stico:</label>
            <textarea
              id="contenido"
              name="contenido"
              rows="10"
              placeholder="Ingrese el diagnÃ³stico, tratamiento recomendado, observaciones y recomendaciones para el paciente..."
              th:text="${dictamen != null ? dictamen.contenido : ''}"
              maxlength="2000"
              oninput="actualizarContador()"
              required
            ></textarea>

            <div id="charCounter" class="char-counter">0 / 2000 caracteres</div>

            <button type="submit" class="btn-guardar">
              ğŸ’¾ Guardar Dictamen
            </button>

            <a href="/dictamen" class="btn-volver"> â† Volver a Lista </a>
          </form>
        </div>

        <!-- Historial de DictÃ¡menes -->
        <div
          class="historial-section"
          th:if="${dictamen != null and dictamen.contenido != null and dictamen.contenido != ''}"
        >
          <h2>ğŸ“š Dictamen Actual</h2>

          <table class="tabla-historial">
            <thead>
              <tr>
                <th>ID Cita</th>
                <th>Contenido del Dictamen</th>
                <th>Ãšltima ModificaciÃ³n</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td th:text="${cita.id}"></td>
                <td>
                  <div
                    class="contenido-completo"
                    th:text="${dictamen.contenido}"
                  ></div>
                </td>
                <td>
                  <span class="badge-guardado">âœ“ Guardado</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Mensaje si no hay dictamen -->
        <div
          class="historial-section"
          th:if="${dictamen == null or dictamen.contenido == null or dictamen.contenido == ''}"
        >
          <h2>ğŸ“š Historial de DictÃ¡menes</h2>
          <p class="mensaje-vacio">
            ğŸ“ No hay dictamen registrado para esta cita. Complete el formulario
            arriba para crear uno.
          </p>
        </div>
      </div>

      <!-- Mostrar si cita es null -->
      <div th:if="${cita == null}" class="mensaje-warning">
        <h2>âš ï¸ Cita no encontrada</h2>
        <p>No se pudo cargar la informaciÃ³n de la cita solicitada.</p>
        <a href="/gestionCitas">
          <button class="btn-guardar">â† Volver a GestiÃ³n de Citas</button>
        </a>
      </div>
    </div>

    <script>
      // Contador de caracteres
      function actualizarContador() {
        const textarea = document.getElementById("contenido");
        const contador = document.getElementById("charCounter");
        const longitud = textarea.value.length;
        contador.textContent = longitud + " / 2000 caracteres";

        if (longitud > 1900) {
          contador.style.color = "#f44336";
        } else if (longitud > 1500) {
          contador.style.color = "#ff9800";
        } else {
          contador.style.color = "#757575";
        }
      }

      // Validar formulario
      function validarFormulario() {
        const contenido = document.getElementById("contenido").value.trim();
        if (contenido.length < 10) {
          alert("âš ï¸ El dictamen debe tener al menos 10 caracteres.");
          return false;
        }
        return true;
      }

      // Inicializar contador al cargar la pÃ¡gina
      window.onload = function () {
        actualizarContador();
      };
    </script>
    <script src="dark-mode.js"></script>
    <script src="dropdown-menu.js"></script>
  </body>
</html>
