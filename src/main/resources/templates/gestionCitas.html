<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" href="/icono.png" />
    <link rel="stylesheet" href="/estilosAdministrativos.css" />
    <link rel="stylesheet" href="/responsive.css" />
    <link rel="stylesheet" href="/gestionCitas.css" />
    <link rel="stylesheet" href="/dropdown-menu.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <title>Gesti√≥n de Citas</title>
  </head>
  <body class="dark-mode">
    <input type="checkbox" id="theme-toggle" style="display: none" />

    <!-- Label que act√∫a como bot√≥n -->
    <label
      for="theme-toggle"
      style="
        cursor: pointer;
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #005b9f;
        color: white;
        padding: 10px;
        border-radius: 5px;
        z-index: 999;
      "
      >üåô</label
    >
    <nav>
      <p class="logo">
        Dr.
        <span
          th:text="${medicoLogueado != null ? medicoLogueado.nombre + ' ' + medicoLogueado.apellido : 'M√©dico Independiente'}"
          >M√©dico Independiente</span
        >
      </p>
      <div class="nav_bar">
        <a href="/paciente">Pacientes</a>
        <a href="/gestionCitas" class="active">Gesti√≥n de Citas</a>
        <a href="/historialCitas">Historial</a>
        <a href="/calendarioMedico">Calendario</a>
        <a href="/dictamen">Dict√°menes</a>
        <a href="/horario">Horarios</a>
        <div class="dropdown">
          <a href="#" class="dropdown-toggle">
            <i class="fas fa-cog"></i> Ajustes <i class="fas fa-chevron-down"></i>
          </a>
          <div class="dropdown-menu">
            <a href="/PerfilMedicoAjustes" class="dropdown-item">
              <i class="fas fa-user-md"></i> Perfil M√©dico
            </a>
            <form action="/logout" method="post" style="margin: 0;">
              <button type="submit" class="dropdown-item logout-item">
                <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
              </button>
            </form>
          </div>
        </div>
      </div>
    </nav>

    <h1>Gesti√≥n de Citas</h1>
    <!-- Mensajes de error y √©xito -->
    <div
      th:if="${error}"
      style="
        background-color: #f8d7da;
        color: #721c24;
        padding: 12px;
        margin: 15px 0;
        border: 1px solid #f5c6cb;
        border-radius: 4px;
      "
    >
      <strong>‚ö†Ô∏è Error:</strong> <span th:text="${error}"></span>
    </div>
    <div
      th:if="${mensaje}"
      style="
        background-color: #d4edda;
        color: #155724;
        padding: 12px;
        margin: 15px 0;
        border: 1px solid #c3e6cb;
        border-radius: 4px;
      "
    >
      <strong>‚úì √âxito:</strong> <span th:text="${mensaje}"></span>
    </div>

    <h2>Registrar Nueva Cita</h2>
    <form
      action="/agregarCita"
      th:object="${cita}"
      method="post"
      class="formulario-cita"
    >
      <label>Paciente:</label>
      <select name="pacienteId" required>
        <option value="">-- Seleccionar Paciente --</option>
        <option
          th:each="pac : ${pacientes}"
          th:value="${pac.id}"
          th:text="${pac.nombre}"
        ></option></select
      ><br /><br />

      <label>Fecha:</label>
      <input
        type="date"
        th:field="*{fecha}"
        name="fecha"
        required
        id="fechaCita"
      /><br /><br />

      <label>Hora:</label>
      <select th:field="*{hora}" name="hora" required>
        <option value="">-- Seleccionar Hora --</option>

        <option value="00:00">12:00 AM</option>
        <option value="00:30">12:30 AM</option>
        <option value="01:00">1:00 AM</option>
        <option value="01:30">1:30 AM</option>
        <option value="02:00">2:00 AM</option>
        <option value="02:30">2:30 AM</option>
        <option value="03:00">3:00 AM</option>
        <option value="03:30">3:30 AM</option>
        <option value="04:00">4:00 AM</option>
        <option value="04:30">4:30 AM</option>
        <option value="05:00">5:00 AM</option>
        <option value="05:30">5:30 AM</option>
        <option value="06:00">6:00 AM</option>
        <option value="06:30">6:30 AM</option>
        <option value="07:00">7:00 AM</option>
        <option value="07:30">7:30 AM</option>
        <option value="08:00">8:00 AM</option>
        <option value="08:30">8:30 AM</option>
        <option value="09:00">9:00 AM</option>
        <option value="09:30">9:30 AM</option>
        <option value="10:00">10:00 AM</option>
        <option value="10:30">10:30 AM</option>
        <option value="11:00">11:00 AM</option>
        <option value="11:30">11:30 AM</option>
        <option value="12:00">12:00 PM</option>
        <option value="12:30">12:30 PM</option>
        <option value="13:00">1:00 PM</option>
        <option value="13:30">1:30 PM</option>
        <option value="14:00">2:00 PM</option>
        <option value="14:30">2:30 PM</option>
        <option value="15:00">3:00 PM</option>
        <option value="15:30">3:30 PM</option>
        <option value="16:00">4:00 PM</option>
        <option value="16:30">4:30 PM</option>
        <option value="17:00">5:00 PM</option>
        <option value="17:30">5:30 PM</option>
        <option value="18:00">6:00 PM</option>
        <option value="18:30">6:30 PM</option>
        <option value="19:00">7:00 PM</option>
        <option value="19:30">7:30 PM</option>
        <option value="20:00">8:00 PM</option>
        <option value="20:30">8:30 PM</option>
        <option value="21:00">9:00 PM</option>
        <option value="21:30">9:30 PM</option>
        <option value="22:00">10:00 PM</option>
        <option value="22:30">10:30 PM</option>
        <option value="23:00">11:00 PM</option>
        <option value="23:30">11:30 PM</option></select
      ><br /><br />

      <label>Motivo:</label>
      <input
        type="text"
        th:field="*{motivo}"
        name="motivo"
        required
      /><br /><br />

      <button type="submit">Guardar Cita</button>
    </form>

    <h2>Listado de Citas</h2>
    <table border="1">
      <thead>
        <tr>
          <th>Paciente</th>
          <th>Fecha</th>
          <th>Hora</th>
          <th>Motivo</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr th:each="cita : ${citas}">
          <td th:text="${cita.pacienteNombre}"></td>
          <td th:text="${cita.fecha}"></td>
          <td class="hora-cell" th:text="${cita.hora}"></td>
          <td th:text="${cita.motivo}"></td>
          <td class="acciones-cell">
            <div class="acciones-container">
              <!-- Formulario oculto para cambiar estado -->
              <form
                method="POST"
                action="/cambiarEstadoCita"
                th:id="'formEstado-' + ${cita.id}"
                style="display: none"
              >
                <input type="hidden" name="citaId" th:value="${cita.id}" />
                <input
                  type="hidden"
                  name="nuevoEstado"
                  th:id="'inputEstado-' + ${cita.id}"
                />
              </form>

              <!-- Select de Estado -->
              <select
                class="estado-select"
                th:data-id="${cita.id}"
                th:data-actual="${cita.estado.name()}"
                onchange="confirmarCambioEstado(this)"
              >
                <option
                  value="PENDIENTE"
                  th:selected="${cita.estado.name() == 'PENDIENTE'}"
                >
                  Pendiente
                </option>
                <option
                  value="CANCELADA"
                  th:selected="${cita.estado.name() == 'CANCELADA'}"
                >
                  Cancelada
                </option>
                <option
                  value="COMPLETADA"
                  th:selected="${cita.estado.name() == 'COMPLETADA'}"
                >
                  Completada
                </option>
                <option
                  value="NO_ASISTIO"
                  th:selected="${cita.estado.name() == 'NO_ASISTIO'}"
                >
                  No Asisti√≥
                </option>
              </select>

              <!-- Botones -->
              <button
                class="btn-editar"
                th:attr="data-id=${cita.id}, data-paciente=${cita.pacienteId}, data-fecha=${cita.fecha}, data-hora=${cita.hora}, data-motivo=${cita.motivo}, data-estado=${cita.estado.name()}"
                onclick="editarCitaData(this)"
              >
                Editar
              </button>

              <a th:href="@{'/cita/' + ${cita.id} + '/dictamen'}">
                <button type="button" class="btn-dictamen">Dictamen</button>
              </a>

              <button
                class="btn-eliminar"
                th:onclick="'confirmarEliminar(' + ${cita.id} + ')'"
              >
                Eliminar
              </button>

              <!-- Formulario oculto para eliminar -->
              <form
                th:action="@{/eliminarCita}"
                method="post"
                th:id="'formEliminar-' + ${cita.id}"
                style="display: none"
              >
                <input type="hidden" name="id" th:value="${cita.id}" />
              </form>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Modal Editar -->
    <div id="modalEditar" class="modal">
      <div class="modal-content">
        <span class="close" onclick="cerrarModal('modalEditar')">&times;</span>
        <h2>Editar Cita</h2>
        <form action="/actualizarCita" method="post">
          <input type="hidden" id="editId" name="id" />

          <div class="form-group">
            <label>Paciente:</label>
            <select id="editPaciente" name="pacienteId" required>
              <option
                th:each="pac : ${pacientes}"
                th:value="${pac.id}"
                th:text="${pac.nombre}"
              ></option>
            </select>
          </div>

          <div class="form-group">
            <label>Fecha:</label>
            <input type="date" id="editFecha" name="fecha" required />
          </div>

          <div class="form-group">
            <label>Hora:</label>
            <input type="time" id="editHora" name="hora" required />
          </div>

          <div class="form-group">
            <label>Motivo:</label>
            <input type="text" id="editMotivo" name="motivo" required />
          </div>

          <div class="modal-buttons">
            <button
              type="button"
              class="btn-cancelar"
              onclick="cerrarModal('modalEditar')"
            >
              Cancelar
            </button>
            <button type="submit" class="btn-confirmar">Actualizar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Confirmar Eliminaci√≥n -->
    <div id="modalEliminar" class="modal">
      <div class="modal-content">
        <span class="close" onclick="cerrarModal('modalEliminar')"
          >&times;</span
        >
        <h2>Confirmar Eliminaci√≥n</h2>
        <p>
          ¬øEst√° seguro de que desea eliminar esta cita? Esta acci√≥n no se puede
          deshacer.
        </p>
        <div class="modal-buttons">
          <button
            type="button"
            class="btn-cancelar"
            onclick="cerrarModal('modalEliminar')"
          >
            Cancelar
          </button>
          <button
            type="button"
            class="btn-confirmar"
            id="btnConfirmarEliminar"
            style="background-color: #dc3545"
          >
            Eliminar
          </button>
        </div>
      </div>
    </div>

    <!-- Modal Confirmar Cambio de Estado -->
    <div id="modalEstado" class="modal">
      <div class="modal-content">
        <span class="close" onclick="cerrarModalEstado()">&times;</span>
        <h2>Cambiar Estado</h2>
        <p>
          ¬øDesea cambiar el estado de la cita a
          <strong id="textoNuevoEstado"></strong>?
        </p>
        <div class="modal-buttons">
          <button
            type="button"
            class="btn-cancelar"
            onclick="cerrarModalEstado()"
          >
            Cancelar
          </button>
          <button type="button" class="btn-confirmar" id="btnConfirmarEstado">
            Confirmar
          </button>
        </div>
      </div>
    </div>

    <script>
      // Variables globales para manejo de estado
      let estadoSelectActual = null;
      let estadoAnterior = null;

      // Convertir horas de formato 24h a 12h con AM/PM
      function convertirHora24a12(hora24) {
        const [horas, minutos] = hora24.split(":");
        let hora = parseInt(horas);
        const ampm = hora >= 12 ? "PM" : "AM";
        hora = hora % 12 || 12;
        return `${hora}:${minutos} ${ampm}`;
      }

      // Aplicar conversi√≥n a todas las celdas de hora
      document.addEventListener("DOMContentLoaded", function () {
        const horasCells = document.querySelectorAll(".hora-cell");
        horasCells.forEach((cell) => {
          const hora24 = cell.textContent.trim();
          cell.textContent = convertirHora24a12(hora24);
        });
      });

      // Funciones para Modal Editar
      function editarCitaData(button) {
        document.getElementById("editId").value =
          button.getAttribute("data-id");
        document.getElementById("editPaciente").value =
          button.getAttribute("data-paciente");
        document.getElementById("editFecha").value =
          button.getAttribute("data-fecha");
        document.getElementById("editHora").value =
          button.getAttribute("data-hora");
        document.getElementById("editMotivo").value =
          button.getAttribute("data-motivo");

        document.getElementById("modalEditar").style.display = "flex";
      }

      // Funciones para Modal Eliminar
      let idCitaAEliminar = null;
      function confirmarEliminar(id) {
        idCitaAEliminar = id;
        document.getElementById("modalEliminar").style.display = "flex";

        document.getElementById("btnConfirmarEliminar").onclick = function () {
          document.getElementById("formEliminar-" + idCitaAEliminar).submit();
        };
      }

      // Funciones para Modal Estado
      function confirmarCambioEstado(selectElement) {
        estadoSelectActual = selectElement;
        estadoAnterior = selectElement.getAttribute("data-actual");
        const nuevoEstado = selectElement.value;
        const textoEstado =
          selectElement.options[selectElement.selectedIndex].text;
        const citaId = selectElement.getAttribute("data-id");

        document.getElementById("textoNuevoEstado").textContent = textoEstado;
        document.getElementById("modalEstado").style.display = "flex";

        document.getElementById("btnConfirmarEstado").onclick = function () {
          document.getElementById("inputEstado-" + citaId).value = nuevoEstado;
          document.getElementById("formEstado-" + citaId).submit();
        };
      }

      function cerrarModalEstado() {
        if (estadoSelectActual) {
          estadoSelectActual.value = estadoAnterior; // Revertir cambio
        }
        document.getElementById("modalEstado").style.display = "none";
      }

      // Funci√≥n gen√©rica para cerrar modales
      function cerrarModal(modalId) {
        document.getElementById(modalId).style.display = "none";
      }

      // Cerrar modales al hacer clic fuera
      window.onclick = function (event) {
        if (event.target.classList.contains("modal")) {
          if (event.target.id === "modalEstado") {
            cerrarModalEstado();
          } else {
            event.target.style.display = "none";
          }
        }
      };

      // Establecer fecha m√≠nima a hoy (permite seleccionar el d√≠a de hoy)
      document.addEventListener("DOMContentLoaded", function () {
        const fechaInput = document.getElementById("fechaCita");
        if (fechaInput) {
          const hoy = new Date();
          const year = hoy.getFullYear();
          const month = String(hoy.getMonth() + 1).padStart(2, "0");
          const day = String(hoy.getDate()).padStart(2, "0");
          const fechaMinima = `${year}-${month}-${day}`;
          fechaInput.setAttribute("min", fechaMinima);
        }
      });
    </script>
    <script src="dark-mode.js"></script>
    <script src="dropdown-menu.js"></script>
  </body>
</html>
